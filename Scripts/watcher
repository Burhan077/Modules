#!/bin/bash

DATAFILE="$HOME/.config/.size.json"
mkdir -p "$(dirname "$DATAFILE")"
if [[ ! -f "$DATAFILE" ]] || ! jq empty "$DATAFILE" 2>/dev/null; then
  echo '{}' > "$DATAFILE"
fi

save_geometry() {
  local win_json=$1
  local app=$(echo "$win_json" | jq -r '.class')
  local floating=$(echo "$win_json" | jq '.floating')
  if [[ "$floating" != "true" ]]; then
    return
  fi
  local x=$(echo "$win_json" | jq '.at[0]')
  local y=$(echo "$win_json" | jq '.at[1]')
  local w=$(echo "$win_json" | jq '.size[0]')
  local h=$(echo "$win_json" | jq '.size[1]')
  jq --arg app "$app" --argjson x "$x" --argjson y "$y" --argjson w "$w" --argjson h "$h" \
    '.[$app] = {x: $x, y: $y, w: $w, h: $h}' "$DATAFILE" > "$DATAFILE.tmp" && mv "$DATAFILE.tmp" "$DATAFILE"
  echo "Saved geometry for $app"
}

restore_geometry() {
  local win_id=$1
  local win_json=$(hyprctl -j clients | jq ".[] | select(.id == $win_id)")
  local app=$(echo "$win_json" | jq -r '.class')
  local x=$(jq -r --arg app "$app" '.[$app].x // empty' "$DATAFILE")
  local y=$(jq -r --arg app "$app" '.[$app].y // empty' "$DATAFILE")
  local w=$(jq -r --arg app "$app" '.[$app].w // empty' "$DATAFILE")
  local h=$(jq -r --arg app "$app" '.[$app].h // empty' "$DATAFILE")

  hyprctl dispatch "[id=$win_id]" togglefloating
  sleep 0.1

  if [[ -n "$x" && -n "$y" && -n "$w" && -n "$h" ]]; then
    hyprctl dispatch "[id=$win_id]" movewindowpixel exact "$x" "$y"
    hyprctl dispatch "[id=$win_id]" resizewindowpixel exact "$w" "$h"
    echo "Restored geometry for $app"
  fi
}

while true; do
  hyprctl -j clients | jq -c '.[]' | while read -r win; do
    ID=$(echo "$win" | jq '.id')
    FLOATING=$(echo "$win" | jq '.floating')
    RESTORED_FLAG="/tmp/hypr_restored_$ID"

    # If floating and not restored yet, restore size/pos
    if [[ "$FLOATING" == "true" && ! -f "$RESTORED_FLAG" ]]; then
      restore_geometry "$ID"
      touch "$RESTORED_FLAG"
    fi
  done

  # Save geometry for all floating windows periodically
  hyprctl -j clients | jq -c '.[]' | while read -r win; do
    FLOATING=$(echo "$win" | jq '.floating')
    if [[ "$FLOATING" == "true" ]]; then
      save_geometry "$win"
    fi
  done

  sleep 5
done

