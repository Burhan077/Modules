#!/bin/bash

# Prompt user for URL and App Name
read -rp "ğŸŒ Enter the website URL (e.g. https://github.com): " site_url
read -rp "ğŸ“› Enter a name for the app (e.g. GitHub): " app_name

# Check if Nativefier is installed
if ! command -v nativefier &> /dev/null; then
    echo "âŒ Nativefier is not installed. Run: sudo npm install -g nativefier"
    exit 1
fi

# Prompt for icon
read -rp "ğŸ–¼ Enter full path to the icon file (PNG or SVG): " icon_path

# Validate icon path
if [ ! -f "$icon_path" ]; then
    echo "âŒ Icon not found! Please run again with a valid path."
    exit 1
fi

# Create a temp icon copy as icon.png in /tmp
tmp_icon_path="/tmp/icon.png"
cp "$icon_path" "$tmp_icon_path"
echo "ğŸ“¥ Icon copied to $tmp_icon_path for use with Nativefier"

# Check/create the target directory
target_dir="$HOME/.local/Apps"
mkdir -p "$target_dir"

# Try to get Electron version
if command -v electron &> /dev/null; then
    elec_ver=$(electron36 --version | sed 's/v//')
    elec_path=$(which electron36)
    echo "âœ… Found Electron $elec_ver at $elec_path"
else
    echo "âš ï¸ Electron not found! Falling back to Nativefier's auto-download."
    elec_ver=""
    elec_path=""
fi

# Show summary
echo "ğŸ“¦ Creating app '$app_name' from '$site_url'..."
echo "ğŸ“ Target directory: $target_dir"

# Run Nativefier
XCURSOR_THEME=Bibata-Modern-Ice XCURSOR_SIZE=24 \
nativefier --name "$app_name" "$site_url" \
  --icon "$tmp_icon_path" \
  --user-agent "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36" \
  --honest \
  --disable-context-menu \
  --disable-dev-tools \
  --inject-styles /dev/null \
  --browserwindow-options '{"webPreferences": {"contextIsolation": true, "sandbox": true}}' \
  --extra-args="--enable-features=WaylandWindowDecorations --ozone-platform-hint=auto" \
  --insecure \
  --internal-urls ".*" \
  --tray

# Define expected folder name
generated_folder="${app_name// /-}-linux-x64"

# Check if it was created
if [ -d "$generated_folder" ]; then
    echo "ğŸš€ Moving '$generated_folder' to $target_dir..."
    mv "$generated_folder" "$target_dir/"
    echo "âœ… App '$app_name' moved successfully to $target_dir!"
else
    echo "âŒ Error: Could not find the generated folder '$generated_folder'."
    exit 1
fi

# Cleanup
rm "$tmp_icon_path"

echo ""
read -rp "âœ… All done! Press Enter to exit..."

